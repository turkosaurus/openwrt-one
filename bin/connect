#!/usr/bin/env bash

usage () {
    echo "Usage: $0 -m <serial|ssh> -f <path-to-pubkey>"
}

debug () {
    if [ -n "$verbose" ]; then
        echo "$@"
    fi
}

info () {
    echo "$@"
}

error () {
    echo "Error: $*"
}

while getopts "m:v" opt; do
    case $opt in
        m)
            mode="$OPTARG"
            ;;
        v)
            verbose=1
            ;;
        k)
            key="$OPTARG"
            ;;
        *)
            usage
            exit 1
            ;;
    esac
done

if [ -n "$verbose" ]; then
    debug "Verbose mode enabled."
fi

if [ -z "$mode" ]; then
    echo "Error: Mode (-m) is required."
    usage
    exit 1
fi

if [ -z "$key" ]; then
    # TODO don't use 2, use better method than ls | grep
    key=$(ls ~/.ssh | grep '\.pub' | xargs | awk '{print $2}')
    key="$HOME/.ssh/$key"
    if [ -z "$key" ]; then
        error "No public key provided, nor found in ~/.ssh"
        usage
        exit 1
    fi
fi
if [ ! -f "$key" ]; then
    error "Public key not found: $key"
    exit 1
else
    echo "Using public key: $key"
fi

case "$mode" in
    serial)
        DEFAULT_BAUD=115200
        echo "Connecting via serial..."
        DEV_TTY=$(sudo dmesg | grep -i tty | head -1 | awk '{print $4}' | sed s/://g)
        if [ -z "$DEV_TTY" ]; then
            error "No serial device found."
            exit 1
        fi
        debug "Serial device found: $DEV_TTY"
        sudo minicom -D "/dev/$DEV_TTY" -b "$DEFAULT_BAUD"
        code="$?"
        info "minicom exited ($code)"
        exit $code
        ;;
    ssh)
        if ! ssh root@openwrt.lan "ls /root/.ssh &> /dev/null"; then
            info "Running initial setup..."

            debug "Creating .ssh dir for root..."
            ssh root@openwrt.lan "mkdir /root/.ssh && chmod 700 /root/.ssh && touch /root/.ssh/authorized_keys"

            debug "Copying public key to authorized_keys"
            ssh root@openwrt.lan "cat >> /root/.ssh/authorized_keys" < "$key"

            debug "Setting permissions"
            ssh root@openwrt.lan "chmod 600 /root/.ssh/authorized_keys"

            debug "Disabling password authentication"

ssh root@openwrt.lan << 'EOF'
uci set dropbear.@dropbear[0].PasswordAuth="0"
uci set dropbear.@dropbear[0].RootPasswordAuth="0"
uci commit dropbear
service dropbear restart
EOF

            debug "Password authentication disabled"
            info "Initial setup complete!"
            if ! ssh -o PasswordAuthentication=no root@openwrt.lan "echo 'SSH passwordless authentication success!'"; then
                error "Initial setup failed."
                exit 1
            fi
        fi
        ssh root@openwrt.lan
        exit 1
        ;;
    *)
        error "Invalid mode: $mode"
        usage
        exit 1
        ;;
esac
